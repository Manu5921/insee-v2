(()=>{var e={};e.id=523,e.ids=[523],e.modules={408:()=>{},523:(e,s,r)=>{"use strict";r.d(s,{z:()=>i});var t=r(2572);!function(){var e=Error("Cannot find module '@supabase/ssr'");throw e.code="MODULE_NOT_FOUND",e}();let n=process.env.NEXT_PUBLIC_SUPABASE_URL||"http://supabasekong-zcc4coo08kkk0ok88o0840k0.89.117.61.193.sslip.io:8000",o=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0";process.env.NEXT_PUBLIC_SUPABASE_URL&&Object(function(){var e=Error("Cannot find module '@supabase/ssr'");throw e.code="MODULE_NOT_FOUND",e}())(n,o);let i=()=>process.env.NEXT_PUBLIC_SUPABASE_URL?(0,t.UU)(n,o,{auth:{autoRefreshToken:!1,persistSession:!1}}):null},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1262:()=>{},1630:e=>{"use strict";e.exports=require("http")},1645:e=>{"use strict";e.exports=require("net")},1997:e=>{"use strict";e.exports=require("punycode")},2503:()=>{},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3358:(e,s,r)=>{"use strict";r.r(s),r.d(s,{patchFetch:()=>h,routeModule:()=>x,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>f});var t={};r.r(t),r.d(t,{POST:()=>d});var n=r(8106),o=r(8819),i=r(2050),a=r(4235);!function(){var e=Error("Cannot find module 'openai'");throw e.code="MODULE_NOT_FOUND",e}();let u=process.env.OPENAI_API_KEY?Object(function(){var e=Error("Cannot find module 'openai'");throw e.code="MODULE_NOT_FOUND",e}())({apiKey:process.env.OPENAI_API_KEY}):null;class c{async analyzeEconomicData(e){try{if(!u)throw Error("OpenAI client not configured");let s=[{role:"system",content:this.systemPrompt},{role:"user",content:this.buildUserPrompt(e)}],r=await u.chat.completions.create({model:"gpt-4-turbo-preview",messages:s,temperature:.3,max_tokens:1500,response_format:{type:"json_object"}}),t=r.choices[0]?.message?.content;if(!t)throw Error("R\xe9ponse vide de OpenAI");let n=JSON.parse(t);return{response:n.response||"D\xe9sol\xe9, je n'ai pas pu analyser cette requ\xeate.",suggestedQueries:n.suggestedQueries||[],dataInsights:n.dataInsights||[],chartSuggestions:n.chartSuggestions||[],sqlQuery:n.sqlQuery}}catch(e){return console.error("Erreur analyse IA:",e),{response:"Je rencontre une difficult\xe9 technique. Pourriez-vous reformuler votre question ?",suggestedQueries:["Quelle est l'\xe9volution du PIB fran\xe7ais cette ann\xe9e ?","Comment le taux de ch\xf4mage a-t-il \xe9volu\xe9 ces 5 derni\xe8res ann\xe9es ?","Quels sont les derniers chiffres de l'inflation ?"]}}}buildUserPrompt(e){let s=`Requ\xeate utilisateur: "${e.query}"

`;return e.data&&e.data.length>0&&(s+=`Donn\xe9es disponibles:
`,s+=JSON.stringify(e.data.slice(0,10),null,2),s+=`
(${e.data.length} enregistrements au total)

`),e.context&&(s+=`Contexte: ${e.context}

`),s+=`R\xe9ponds au format JSON avec cette structure:
{
  "response": "R\xe9ponse d\xe9taill\xe9e en fran\xe7ais",
  "dataInsights": ["Insight 1", "Insight 2", "..."],
  "suggestedQueries": ["Question 1", "Question 2", "..."],
  "chartSuggestions": [
    {
      "type": "line|bar|pie",
      "title": "Titre du graphique",
      "description": "Description du graphique recommand\xe9"
    }
  ],
  "sqlQuery": "SELECT ... (si applicable)"
}`}constructor(){this.systemPrompt=`Tu es un expert \xe9conomiste sp\xe9cialis\xe9 dans l'analyse des donn\xe9es fran\xe7aises et europ\xe9ennes.
Tu as acc\xe8s aux donn\xe9es de l'INSEE, Eurostat et autres sources officielles.

Tes comp\xe9tences :
- Analyse des indicateurs \xe9conomiques (PIB, ch\xf4mage, inflation, etc.)
- Interpr\xe9tation des tendances et cycles \xe9conomiques  
- Corr\xe9lations entre diff\xe9rents indicateurs
- Pr\xe9visions \xe0 court terme bas\xe9es sur les donn\xe9es historiques
- Recommandations de politique \xe9conomique

Format de r\xe9ponse :
1. R\xe9ponse claire et p\xe9dagogique en fran\xe7ais
2. Donn\xe9es chiffr\xe9es pr\xe9cises quand disponibles
3. Suggestions de visualisations pertinentes
4. Questions de suivi int\xe9ressantes

Garde un ton professionnel mais accessible, adapt\xe9 \xe0 un public non-expert.`}}let l=new c;var p=r(523);async function d(e){try{var s;let{query:r,conversation:t=[]}=await e.json();if(!r||"string"!=typeof r)return a.NextResponse.json({error:"Question requise"},{status:400});if(!process.env.OPENAI_API_KEY)return a.NextResponse.json({response:"Le service IA n'est pas configur\xe9. Veuillez configurer OPENAI_API_KEY.",suggestedQueries:["Voir les donn\xe9es disponibles","Afficher les derniers indicateurs","Exporter les donn\xe9es"]});let n=(0,p.z)(),o=[];try{if(!n)return a.NextResponse.json({response:"Mode d\xe9mo : Cette application analyse les donn\xe9es \xe9conomiques fran\xe7aises et europ\xe9ennes. Vous pouvez explorer le PIB, le ch\xf4mage, l'inflation, etc. En mode production avec Supabase, je peux analyser vos donn\xe9es sp\xe9cifiques.",data:[{indicator:"PIB France",value:2850.5,date:"2024-03-31",source:"INSEE"}]});let e=function(e){let s=e.toLowerCase(),r={};return s.includes("pib")||s.includes("gdp")?r.category="GDP":s.includes("ch\xf4mage")||s.includes("unemployment")?r.category="UNEMPLOYMENT":s.includes("inflation")||s.includes("prix")?r.category="INFLATION":s.includes("production")||s.includes("industriel")?r.category="INDUSTRIAL_PRODUCTION":s.includes("dette")||s.includes("debt")?r.category="GOVERNMENT_DEBT":(s.includes("confiance")||s.includes("confidence"))&&(r.category="CONSUMER_CONFIDENCE"),s.includes("france")||s.includes("fran\xe7ais")?r.geography="France":(s.includes("europe")||s.includes("eu")||s.includes("ue"))&&(r.geography="UE"),s.includes("insee")?r.source="INSEE":s.includes("eurostat")&&(r.source="EUROSTAT"),r}(r),s=n.from("economic_data").select("*").order("date",{ascending:!1}).limit(20);e.category&&(s=s.eq("category",e.category)),e.geography&&(s=s.ilike("geography",`%${e.geography}%`)),e.source&&(s=s.eq("source",e.source));let{data:t,error:i}=await s;!i&&t&&(o=t)}catch(e){console.error("Erreur base de donn\xe9es:",e)}let i=await l.analyzeEconomicData({query:r,data:o,context:(s=t).length?s.slice(-6).map(e=>`${e.role}: ${e.content}`).join("\n"):"",language:"fr"});if(n)try{let s=function(e){let s=e.headers.get("x-forwarded-for"),r=s?.split(",")[0]||"unknown",t=Date.now();return`${r}_${t}`.replace(/[^a-zA-Z0-9_]/g,"_")}(e);await n.from("ai_conversations").insert({session_id:s,user_message:r,ai_response:i.response,data_queries:o.length>0?{count:o.length}:null,response_time:Date.now()-performance.now()})}catch(e){console.error("Erreur sauvegarde conversation:",e)}return a.NextResponse.json(i)}catch(e){return console.error("Erreur API ai-chat:",e),a.NextResponse.json({response:"Je rencontre une difficult\xe9 technique. Pourriez-vous reformuler votre question ?",suggestedQueries:["Quelle est l'\xe9volution du PIB fran\xe7ais cette ann\xe9e ?","Comment le taux de ch\xf4mage a-t-il \xe9volu\xe9 ces 5 derni\xe8res ann\xe9es ?","Quels sont les derniers chiffres de l'inflation ?"]})}}let x=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/ai-chat/route",pathname:"/api/ai-chat",filename:"route",bundlePath:"app/api/ai-chat/route"},resolvedPagePath:"/Users/manu/Documents/DEV/stats-insee/apps/web/src/app/api/ai-chat/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:g,workUnitAsyncStorage:f,serverHooks:m}=x;function h(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:f})}},4075:e=>{"use strict";e.exports=require("zlib")},4631:e=>{"use strict";e.exports=require("tls")},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},7032:()=>{},7910:e=>{"use strict";e.exports=require("stream")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},9551:e=>{"use strict";e.exports=require("url")}};var s=require("../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[191,744,572],()=>r(3358));module.exports=t})();